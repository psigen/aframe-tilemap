!function(e,a){"object"==typeof exports&&"object"==typeof module?module.exports=a(require("THREE"),require("AFRAME")):"function"==typeof define&&define.amd?define("aframeTilemap",["THREE","AFRAME"],a):"object"==typeof exports?exports.aframeTilemap=a(require("THREE"),require("AFRAME")):e.aframeTilemap=a(e.THREE,e.AFRAME)}("undefined"!=typeof self?self:this,function(e,a){return function(e){function a(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,a),r.l=!0,r.exports}var t={};return a.m=e,a.c=t,a.d=function(e,t,i){a.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:i})},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,a){return Object.prototype.hasOwnProperty.call(e,a)},a.p="",a(a.s=3)}([function(a,t){a.exports=e},function(e,t){e.exports=a},function(e,a,t){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.SHADERLIB_MATERIALS={MeshBasicMaterial:THREE.ShaderLib.basic,MeshStandardMaterial:THREE.ShaderLib.standard},a.M_TAU_SCALED=2*Math.PI/256,a.Z_AXIS=new THREE.Vector3(0,0,1)},function(e,a,t){"use strict";t(4),t(5),t(7),AFRAME.registerComponent("tile",{schema:{id:{type:"int"},isLoaded:{type:"boolean",default:!1}}})},function(e,a,t){"use strict";var i=function(){function e(e,a){var t=[],i=!0,r=!1,n=void 0;try{for(var o,l=e[Symbol.iterator]();!(i=(o=l.next()).done)&&(t.push(o.value),!a||t.length!==a);i=!0);}catch(e){r=!0,n=e}finally{try{!i&&l.return&&l.return()}finally{if(r)throw n}}return t}return function(a,t){if(Array.isArray(a))return a;if(Symbol.iterator in Object(a))return e(a,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),r=t(0),n=(function(e){if(e&&e.__esModule)return e;var a={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(a[t]=e[t]);a.default=e}(r),t(1)),o=function(e){return e&&e.__esModule?e:{default:e}}(n),l=t(2);o.default.registerComponent("tilemap-cloned",{schema:{src:{type:"asset"},tileWidth:{type:"number",default:10},tileHeight:{type:"number",default:10},origin:{type:"vec2",default:{x:.5,y:.5}},debug:{type:"boolean",default:!0}},init:function(){var e=this.el,a=this.tiles={},t=!0,i=!1,r=void 0;try{for(var n,o=e.children[Symbol.iterator]();!(t=(n=o.next()).done);t=!0){var l=n.value,s=l.components.tile;s&&(a[s.data]=s)}}catch(e){i=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(i)throw r}}this.constructClones()},constructClones:function(){var e=performance.now(),a=this.tiles,t=this.data.src,r=t.naturalWidth,n=t.naturalHeight,o=this.data.tileWidth,s=this.data.tileHeight,u=-o*r*this.data.origin.x,c=-s*n*this.data.origin.y,p=document.createElement("canvas"),m=p.getContext("2d");m.drawImage(t,0,0);for(var f=m.getImageData(0,0,r,n).data,d=0,v=0;v<n;++v)for(var M=0;M<r;++M){var h=f.slice(d,d+4),y=i(h,4),g=y[0],b=y[1],S=y[2];y[3];d+=4;var x=256*g+b,E=l.M_TAU_SCALED*S;if(x in a){var A=a[x],T=A.el.object3D,w=T.clone();w.translateX(o*M+u),w.translateY(s*v+c),w.rotateZ(E),w.visible=!0,this.el.object3D.add(w)}}if(this.data.debug){var _=performance.now();console.log("Tile cloning took "+(_-e)+" milliseconds.")}}})},function(e,a,t){"use strict";var i=function(){function e(e,a){var t=[],i=!0,r=!1,n=void 0;try{for(var o,l=e[Symbol.iterator]();!(i=(o=l.next()).done)&&(t.push(o.value),!a||t.length!==a);i=!0);}catch(e){r=!0,n=e}finally{try{!i&&l.return&&l.return()}finally{if(r)throw n}}return t}return function(a,t){if(Array.isArray(a))return a;if(Symbol.iterator in Object(a))return e(a,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),r=t(0),n=function(e){if(e&&e.__esModule)return e;var a={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(a[t]=e[t]);return a.default=e,a}(r),o=t(1),l=function(e){return e&&e.__esModule?e:{default:e}}(o),s=t(6),u=t(2);l.default.registerComponent("tilemap-instanced",{schema:{src:{type:"asset"},tileWidth:{type:"number",default:2},tileHeight:{type:"number",default:2},origin:{type:"vec2",default:{x:.5,y:.5}},debug:{type:"boolean",default:!0}},init:function(){var e=this,a=this.el,t=this.tiles={},i=!0,r=!1,n=void 0;try{for(var o,l=a.children[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var s=o.value,u=s.components.tile;u&&(t[u.data.id]={entity:u,meshes:{},instances:{offsets:[]}})}}catch(e){r=!0,n=e}finally{try{!i&&l.return&&l.return()}finally{if(r)throw n}}this.constructTiles().then(function(){e.constructInstances(),e.constructMeshes()})},constructMeshes:function(){var e=performance.now(),a=this.tiles;for(var t in a){var i=a[t],r=i.instances;if(!(r.offsets.length<=0)){var o=new n.InstancedBufferAttribute(new Float32Array(r.offsets),3);for(var l in i.meshes){var c=i.meshes[l],p=c.geometry,m=c.mesh.material,f=u.SHADERLIB_MATERIALS[m.type],d=n.UniformsUtils.clone(f.uniforms);(0,s.updateUniforms)(d,m);var v=new n.ShaderMaterial({uniforms:d,vertexShader:document.getElementById("vertexShader").textContent,fragmentShader:f.fragmentShader,lights:m.lights,defines:{USE_MAP:!!m.map,USE_ENVMAP:!!m.envMap,USE_AOMAP:!!m.aoMap,USE_EMISSIVEMAP:!!m.emissiveMap,USE_BUMPMAP:!!m.bumpMap,USE_NORMALMAP:!!m.normalMap,USE_SPECULARMAP:!!m.specularMap,USE_ROUGHNESSMAP:!!m.roughnessMap,USE_METALNESSMAP:!!m.metalnessMap,USE_ALPHAMAP:!!m.alphaMap,USE_COLOR:!!m.vertexColors,FLAT_SHADED:!!m.flatShading,DOUBLE_SIDED:!!m.doubleSided,FLIP_SIDED:!m.flipSided}}),M=new n.InstancedBufferGeometry;M.index=p.index;for(var h in p.attributes)M.addAttribute(h,p.getAttribute(h));M.addAttribute("tilemapOffset",o);var y=new n.Mesh(M,v);this.el.object3D.add(y)}}}if(this.data.debug){var g=performance.now();console.log("Tile mesh creation took "+(g-e).toFixed(2)+" ms.")}},constructInstances:function(){var e=performance.now(),a=this.tiles,t=this.data.src,r=t.naturalWidth,n=t.naturalHeight,o=this.data.tileWidth,l=this.data.tileHeight,s=-o*r*this.data.origin.x,c=-l*n*this.data.origin.y,p=document.createElement("canvas"),m=p.getContext("2d");m.drawImage(t,0,0);for(var f=m.getImageData(0,0,r,n).data,d=0,v=0;v<n;++v)for(var M=0;M<r;++M){var h=f.slice(d,d+4),y=i(h,4),g=y[0],b=y[1],S=y[2];y[3];d+=4;var x=256*g+b;if(x in a){var E=a[x].instances,A=o*M+s,T=l*v+c,w=u.M_TAU_SCALED*S;E.offsets.push(A,T,w)}}if(this.data.debug){var _=performance.now();console.log("Tile instancing took "+(_-e).toFixed(2)+" ms.")}},constructTiles:function(){var e=performance.now(),a=this.tiles,t=[];this.el.object3D.updateMatrixWorld();var i=(new n.Matrix4).getInverse(this.el.object3D.matrixWorld);for(var r in a)!function(e){var r=a[e],o=r.meshes,l=new Promise(function(e,a){var t=function(){r.entity.el.object3D.traverse(function(e){if("Mesh"===e.type){var a=e.geometry instanceof n.BufferGeometry?(new n.BufferGeometry).copy(e.geometry):(new n.BufferGeometry).fromGeometry(e.geometry);e.updateMatrixWorld();var t=(new n.Matrix4).copy(i).multiply(e.matrixWorld);a.applyMatrix(t),o[e.uuid]={mesh:e,geometry:a}}}),e()};r.entity.data.isLoaded?r.entity.el.addEventListener("model-loaded",function(e){setTimeout(function(){t()},100)}):t()});t.push(l)}(r);if(this.data.debug){var o=performance.now();console.log("Tile definition took "+(o-e).toFixed(2)+" ms.")}return Promise.all(t)},update:function(e){},remove:function(){}})},function(e,a,t){"use strict";function i(e,a){e.opacity.value=a.opacity,a.color&&(e.diffuse.value=a.color),a.emissive&&e.emissive.value.copy(a.emissive).multiplyScalar(a.emissiveIntensity),a.map&&(e.map.value=a.map),a.alphaMap&&(e.alphaMap.value=a.alphaMap),a.specularMap&&(e.specularMap.value=a.specularMap),a.envMap&&(e.envMap.value=a.envMap,e.flipEnvMap.value=a.envMap&&a.envMap.isCubeTexture?-1:1,e.reflectivity.value=a.reflectivity,e.refractionRatio.value=a.refractionRatio),a.lightMap&&(e.lightMap.value=a.lightMap,e.lightMapIntensity.value=a.lightMapIntensity),a.aoMap&&(e.aoMap.value=a.aoMap,e.aoMapIntensity.value=a.aoMapIntensity);var t;if(a.map?t=a.map:a.specularMap?t=a.specularMap:a.displacementMap?t=a.displacementMap:a.normalMap?t=a.normalMap:a.bumpMap?t=a.bumpMap:a.roughnessMap?t=a.roughnessMap:a.metalnessMap?t=a.metalnessMap:a.alphaMap?t=a.alphaMap:a.emissiveMap&&(t=a.emissiveMap),void 0!==t){if(t.isWebGLRenderTarget&&(t=t.texture),!0===t.matrixAutoUpdate){var i=t.offset,r=t.repeat,n=t.rotation,o=t.center;t.matrix.setUvTransform(i.x,i.y,r.x,r.y,n,o.x,o.y)}e.uvTransform&&e.uvTransform.value.copy(t.matrix)}}function r(e,a){e.diffuse.value=a.color,e.opacity.value=a.opacity}function n(e,a){e.dashSize.value=a.dashSize,e.totalSize.value=a.dashSize+a.gapSize,e.scale.value=a.scale}function o(e,a){if(e.diffuse.value=a.color,e.opacity.value=a.opacity,e.size.value=a.size*_pixelRatio,e.scale.value=.5*_height,e.map.value=a.map,null!==a.map){if(!0===a.map.matrixAutoUpdate){var t=a.map.offset,i=a.map.repeat,r=a.map.rotation,n=a.map.center;a.map.matrix.setUvTransform(t.x,t.y,i.x,i.y,r,n.x,n.y)}e.uvTransform&&e.uvTransform.value.copy(a.map.matrix)}}function l(e,a){e.fogColor.value=a.color,a.isFog?(e.fogNear.value=a.near,e.fogFar.value=a.far):a.isFogExp2&&(e.fogDensity.value=a.density)}function s(e,a){a.emissiveMap&&(e.emissiveMap.value=a.emissiveMap)}function u(e,a){e.specular.value=a.specular,e.shininess.value=Math.max(a.shininess,1e-4),a.emissiveMap&&(e.emissiveMap.value=a.emissiveMap),a.bumpMap&&(e.bumpMap.value=a.bumpMap,e.bumpScale.value=a.bumpScale),a.normalMap&&(e.normalMap.value=a.normalMap,e.normalScale.value.copy(a.normalScale)),a.displacementMap&&(e.displacementMap.value=a.displacementMap,e.displacementScale.value=a.displacementScale,e.displacementBias.value=a.displacementBias)}function c(e,a){u(e,a),a.gradientMap&&(e.gradientMap.value=a.gradientMap)}function p(e,a){e.roughness.value=a.roughness,e.metalness.value=a.metalness,a.roughnessMap&&(e.roughnessMap.value=a.roughnessMap),a.metalnessMap&&(e.metalnessMap.value=a.metalnessMap),a.emissiveMap&&(e.emissiveMap.value=a.emissiveMap),a.bumpMap&&(e.bumpMap.value=a.bumpMap,e.bumpScale.value=a.bumpScale),a.normalMap&&(e.normalMap.value=a.normalMap,e.normalScale.value.copy(a.normalScale)),a.displacementMap&&(e.displacementMap.value=a.displacementMap,e.displacementScale.value=a.displacementScale,e.displacementBias.value=a.displacementBias),a.envMap&&(e.envMapIntensity.value=a.envMapIntensity)}function m(e,a){e.clearCoat.value=a.clearCoat,e.clearCoatRoughness.value=a.clearCoatRoughness,p(e,a)}function f(e,a){a.displacementMap&&(e.displacementMap.value=a.displacementMap,e.displacementScale.value=a.displacementScale,e.displacementBias.value=a.displacementBias)}function d(e,a){a.displacementMap&&(e.displacementMap.value=a.displacementMap,e.displacementScale.value=a.displacementScale,e.displacementBias.value=a.displacementBias),e.referencePosition.value.copy(a.referencePosition),e.nearDistance.value=a.nearDistance,e.farDistance.value=a.farDistance}function v(e,a){a.bumpMap&&(e.bumpMap.value=a.bumpMap,e.bumpScale.value=a.bumpScale),a.normalMap&&(e.normalMap.value=a.normalMap,e.normalScale.value.copy(a.normalScale)),a.displacementMap&&(e.displacementMap.value=a.displacementMap,e.displacementScale.value=a.displacementScale,e.displacementBias.value=a.displacementBias)}function M(e,a){a.fog&&l(e,a.fog),a.isMeshBasicMaterial?i(e,a):a.isMeshLambertMaterial?(i(e,a),s(e,a)):a.isMeshPhongMaterial?(i(e,a),a.isMeshToonMaterial?c(e,a):u(e,a)):a.isMeshStandardMaterial?(i(e,a),a.isMeshPhysicalMaterial?m(e,a):p(e,a)):a.isMeshDepthMaterial?(i(e,a),f(e,a)):a.isMeshDistanceMaterial?(i(e,a),d(e,a)):a.isMeshNormalMaterial?(i(e,a),v(e,a)):a.isLineBasicMaterial?(r(e,a),a.isLineDashedMaterial&&n(e,a)):a.isPointsMaterial?o(e,a):a.isShadowMaterial&&(e.color.value=a.color,e.opacity.value=a.opacity),void 0!==e.ltcMat&&(e.ltcMat.value=THREE.UniformsLib.LTC_MAT_TEXTURE),void 0!==e.ltcMag&&(e.ltcMag.value=THREE.UniformsLib.LTC_MAG_TEXTURE)}Object.defineProperty(a,"__esModule",{value:!0}),a.updateUniforms=M},function(e,a,t){"use strict";var i=function(){function e(e,a){var t=[],i=!0,r=!1,n=void 0;try{for(var o,l=e[Symbol.iterator]();!(i=(o=l.next()).done)&&(t.push(o.value),!a||t.length!==a);i=!0);}catch(e){r=!0,n=e}finally{try{!i&&l.return&&l.return()}finally{if(r)throw n}}return t}return function(a,t){if(Array.isArray(a))return a;if(Symbol.iterator in Object(a))return e(a,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),r=t(0),n=function(e){if(e&&e.__esModule)return e;var a={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(a[t]=e[t]);return a.default=e,a}(r),o=t(1),l=function(e){return e&&e.__esModule?e:{default:e}}(o),s=t(2);l.default.registerComponent("tilemap-merged",{schema:{src:{type:"asset"},tileWidth:{type:"number",default:2},tileHeight:{type:"number",default:2},origin:{type:"vec2",default:{x:.5,y:.5}},debug:{type:"boolean",default:!0}},init:function(){var e=this,a=this.el,t=this.tiles={},i=!0,r=!1,n=void 0;try{for(var o,l=a.children[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var s=o.value,u=s.components.tile;u&&(t[u.data.id]=u)}}catch(e){r=!0,n=e}finally{try{!i&&l.return&&l.return()}finally{if(r)throw n}}this.constructTiles().then(function(){e.constructGeometry(),e.constructMeshes()})},constructMeshes:function(){var e=performance.now(),a=this.tileMeshes,t=this.mapMeshes={},i=this.mapGeometries;for(var r in a){var o=a[r],l=i[r],s={};for(var u in l){var c=l[u],p=o[u],m=new n.Mesh(c,p.material);this.el.object3D.add(m),s[u]=m}t[r]=s}if(this.data.debug){var f=performance.now();console.log("Tile mesh creation took "+(f-e).toFixed(2)+" ms.")}},constructGeometry:function(){var e=performance.now(),a=this.tiles,t=this.data.src,r=t.naturalWidth,o=t.naturalHeight,l=this.data.tileWidth,u=this.data.tileHeight,c=-l*r*this.data.origin.x,p=-u*o*this.data.origin.y,m=document.createElement("canvas"),f=m.getContext("2d");f.drawImage(t,0,0);var d=f.getImageData(0,0,r,o).data;this.el.object3D.parent.updateMatrixWorld();for(var v=(new n.Matrix4).getInverse(this.el.object3D.matrixWorld),M=0,h=0;h<o;++h)for(var y=0;y<r;++y){var g=d.slice(M,M+4),b=i(g,4),S=b[0],x=b[1],E=b[2];b[3];M+=4;var A=256*S+x,T=s.M_TAU_SCALED*E;if(A in a){var w=l*y+c,_=u*h+p;this.addTileGeometry(A,w,_,T,v)}}if(this.data.debug){var D=performance.now();console.log("Tile geometry merging took "+(D-e).toFixed(2)+" ms.")}},addTileGeometry:function(e,a,t,i,r){var o=this.mapGeometries[e],l=this.tileMeshes[e];for(var s in l){var u=l[s],c=o[s],p=(new n.Matrix4).makeTranslation(a,t,0);p.multiply((new n.Matrix4).makeRotationZ(i)),p.multiply(r),p.multiply(u.matrixWorld);var m=u.geometry;m instanceof n.BufferGeometry&&(m=(new n.Geometry).fromBufferGeometry(u.geometry)),c.merge(m,p)}},constructTiles:function(){var e=performance.now(),a=this.tiles,t=[],i=this.mapGeometries={},r=this.tileMeshes={};for(var o in a)!function(e){var o=a[e],l=new Promise(function(a,t){var l=function(){var t={},l={};o.el.object3D.traverse(function(e){if("Mesh"===e.type){var a=e.parent.uuid;e.parent.updateMatrixWorld(),t[a]=e;var i=new n.Geometry;l[a]=i}}),i[e]=l,r[e]=t,a()};o.data.isLoaded?o.el.addEventListener("model-loaded",function(e){setTimeout(function(){l()},100)}):l()});t.push(l)}(o);if(this.data.debug){var l=performance.now();console.log("Tile cache creation took "+(l-e).toFixed(2)+" ms.")}return Promise.all(t)},update:function(e){},remove:function(){}})}])});