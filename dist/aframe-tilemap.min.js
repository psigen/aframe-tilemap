!function(e,a){"object"==typeof exports&&"object"==typeof module?module.exports=a(require("THREE"),require("AFRAME")):"function"==typeof define&&define.amd?define("aframeTilemap",["THREE","AFRAME"],a):"object"==typeof exports?exports.aframeTilemap=a(require("THREE"),require("AFRAME")):e.aframeTilemap=a(e.THREE,e.AFRAME)}("undefined"!=typeof self?self:this,function(e,a){return function(e){function a(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,a),n.l=!0,n.exports}var t={};return a.m=e,a.c=t,a.d=function(e,t,i){a.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:i})},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,a){return Object.prototype.hasOwnProperty.call(e,a)},a.p="",a(a.s=0)}([function(e,a,t){"use strict";var i=function(){function e(e,a){var t=[],i=!0,n=!1,r=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(t.push(o.value),!a||t.length!==a);i=!0);}catch(e){n=!0,r=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw r}}return t}return function(a,t){if(Array.isArray(a))return a;if(Symbol.iterator in Object(a))return e(a,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),n=t(1),r=function(e){if(e&&e.__esModule)return e;var a={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(a[t]=e[t]);return a.default=e,a}(n),o=t(2),s=function(e){return e&&e.__esModule?e:{default:e}}(o),l=t(3),u={MeshBasicMaterial:r.ShaderLib.basic,MeshStandardMaterial:r.ShaderLib.standard},p=2*Math.PI/256;new r.Vector3(0,0,1);s.default.registerComponent("instanced-tilemap",{schema:{src:{type:"asset"},tileWidth:{type:"number",default:2},tileHeight:{type:"number",default:2},origin:{type:"vec2",default:{x:.5,y:.5}},debug:{type:"boolean",default:!0}},init:function(){var e=this,a=this.el,t=this.tiles={},i=!0,n=!1,r=void 0;try{for(var o,s=a.children[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value,u=l.components.tile;u&&(t[u.data.id]={entity:u,meshes:{},instances:{offsets:[]}})}}catch(e){n=!0,r=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw r}}this.constructTiles().then(function(){e.constructGeometry(),e.constructMeshes()})},constructMeshes:function(){var e=performance.now(),a=this.tiles;for(var t in a){var i=a[t],n=i.instances;if(!(n.offsets.length<=0)){var o=new r.InstancedBufferAttribute(new Float32Array(n.offsets),3);for(var s in i.meshes){var p=i.meshes[s],c=p.geometry,m=p.mesh.material,d=u[m.type],f=r.UniformsUtils.clone(d.uniforms);(0,l.updateUniforms)(f,m),m.type;var v=new r.ShaderMaterial({uniforms:f,vertexShader:document.getElementById("vertexShader").textContent,fragmentShader:d.fragmentShader,lights:m.lights,defines:{USE_MAP:!!m.map,USE_ENVMAP:!!m.envMap,USE_AOMAP:!!m.aoMap,USE_EMISSIVEMAP:!!m.emissiveMap,USE_BUMPMAP:!!m.bumpMap,USE_NORMALMAP:!!m.normalMap,USE_SPECULARMAP:!!m.specularMap,USE_ROUGHNESSMAP:!!m.roughnessMap,USE_METALNESSMAP:!!m.metalnessMap,USE_ALPHAMAP:!!m.alphaMap,USE_COLOR:!!m.vertexColors,FLAT_SHADED:!!m.flatShading,DOUBLE_SIDED:!!m.doubleSided,FLIP_SIDED:!m.flipSided}}),M=new r.InstancedBufferGeometry;M.index=c.index;for(var h in c.attributes)M.addAttribute(h,c.getAttribute(h));M.addAttribute("tilemapOffset",o);var y=new r.Mesh(M,v);this.el.object3D.add(y)}}}if(this.data.debug){var g=performance.now();console.log("Tile map baking took "+(g-e).toFixed(2)+" ms.")}},constructGeometry:function(){var e=performance.now(),a=this.tiles,t=this.data.src,n=t.naturalWidth,r=t.naturalHeight,o=this.data.tileWidth,s=this.data.tileHeight,l=-o*n*this.data.origin.x,u=-s*r*this.data.origin.y,c=document.createElement("canvas"),m=c.getContext("2d");m.drawImage(t,0,0);for(var d=m.getImageData(0,0,n,r).data,f=0,v=0;v<r;++v)for(var M=0;M<n;++M){var h=d.slice(f,f+4),y=i(h,4),g=y[0],b=y[1],S=y[2];y[3];f+=4;var x=256*g+b;if(x in a){var E=a[x].instances,T=o*M+l,w=s*v+u,A=p*S;E.offsets.push(T,w,A)}}if(this.data.debug){var P=performance.now();console.log("Tile map parsing took "+(P-e).toFixed(2)+" ms.")}},constructTiles:function(){var e=performance.now(),a=this.tiles,t=[];this.el.object3D.updateMatrixWorld();var i=(new r.Matrix4).getInverse(this.el.object3D.matrixWorld);for(var n in a)!function(e){var n=a[e],o=n.meshes,s=new Promise(function(e,a){var t=function(){n.entity.el.object3D.traverse(function(e){if("Mesh"===e.type){var a=e.geometry instanceof r.BufferGeometry?(new r.BufferGeometry).copy(e.geometry):(new r.BufferGeometry).fromGeometry(e.geometry);e.updateMatrixWorld();var t=(new r.Matrix4).copy(i).multiply(e.matrixWorld);a.applyMatrix(t),o[e.uuid]={mesh:e,geometry:a}}}),e()};n.entity.data.isLoaded?n.entity.el.addEventListener("model-loaded",function(e){setTimeout(function(){t()},100)}):t()});t.push(s)}(n);if(this.data.debug){var o=performance.now();console.log("Tile definition took "+(o-e).toFixed(2)+" ms.")}return Promise.all(t)},update:function(e){},remove:function(){}}),s.default.registerComponent("tilemap",{schema:{src:{type:"asset"},tileWidth:{type:"number",default:2},tileHeight:{type:"number",default:2},origin:{type:"vec2",default:{x:.5,y:.5}},debug:{type:"boolean",default:!0}},init:function(){var e=this,a=this.el,t=this.tiles={},i=!0,n=!1,r=void 0;try{for(var o,s=a.children[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value,u=l.components.tile;u&&(t[u.data.id]=u)}}catch(e){n=!0,r=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw r}}this.constructTiles().then(function(){e.constructGeometry(),e.constructMeshes()})},constructMeshes:function(){var e=performance.now(),a=this.tileMeshes,t=this.mapMeshes={},i=this.mapGeometries;for(var n in a){var o=a[n],s=i[n],l={};for(var u in s){var p=s[u],c=o[u],m=new r.Mesh(p,c.material);this.el.object3D.add(m),l[u]=m}t[n]=l}if(this.data.debug){var d=performance.now();console.log("Tile map baking took "+(d-e).toFixed(2)+" ms.")}},constructGeometry:function(){var e=performance.now(),a=2*Math.PI/256,t=this.tiles,n=this.data.src,o=n.naturalWidth,s=n.naturalHeight,l=this.data.tileWidth,u=this.data.tileHeight,p=-l*o*this.data.origin.x,c=-u*s*this.data.origin.y,m=document.createElement("canvas"),d=m.getContext("2d");d.drawImage(n,0,0);var f=d.getImageData(0,0,o,s).data;this.el.object3D.parent.updateMatrixWorld();for(var v=(new r.Matrix4).getInverse(this.el.object3D.matrixWorld),M=0,h=0;h<s;++h)for(var y=0;y<o;++y){var g=f.slice(M,M+4),b=i(g,4),S=b[0],x=b[1],E=b[2];b[3];M+=4;var T=256*S+x,w=a*E;if(T in t){var A=l*y+p,P=u*h+c;this.addTileGeometry(T,A,P,w,v)}}if(this.data.debug){var _=performance.now();console.log("Tile mesh creation took "+(_-e).toFixed(2)+" ms.")}},addTileGeometry:function(e,a,t,i,n){var o=this.mapGeometries[e],s=this.tileMeshes[e];for(var l in s){var u=s[l],p=o[l],c=(new r.Matrix4).makeTranslation(a,t,0);c.multiply((new r.Matrix4).makeRotationZ(i)),c.multiply(n),c.multiply(u.matrixWorld);var m=u.geometry;m instanceof r.BufferGeometry&&(m=(new r.Geometry).fromBufferGeometry(u.geometry)),p.merge(m,c)}},constructTiles:function(){var e=performance.now(),a=this.tiles,t=[],i=this.mapGeometries={},n=this.tileMeshes={};for(var o in a)!function(e){var o=a[e],s=new Promise(function(a,t){var s=function(){var t={},s={};o.el.object3D.traverse(function(e){if("Mesh"===e.type){var a=e.parent.uuid;e.parent.updateMatrixWorld(),t[a]=e;var i=new r.Geometry;s[a]=i}}),i[e]=s,n[e]=t,a()};o.data.isLoaded?o.el.addEventListener("model-loaded",function(e){s()}):s()});t.push(s)}(o);if(this.data.debug){var s=performance.now();console.log("Tile cache creation took "+(s-e).toFixed(2)+" ms.")}return Promise.all(t)},update:function(e){},remove:function(){}}),s.default.registerComponent("tile",{schema:{id:{type:"int"},isLoaded:{type:"boolean",default:!1}}})},function(a,t){a.exports=e},function(e,t){e.exports=a},function(e,a,t){"use strict";function i(e,a){e.opacity.value=a.opacity,a.color&&(e.diffuse.value=a.color),a.emissive&&e.emissive.value.copy(a.emissive).multiplyScalar(a.emissiveIntensity),a.map&&(e.map.value=a.map),a.alphaMap&&(e.alphaMap.value=a.alphaMap),a.specularMap&&(e.specularMap.value=a.specularMap),a.envMap&&(e.envMap.value=a.envMap,e.flipEnvMap.value=a.envMap&&a.envMap.isCubeTexture?-1:1,e.reflectivity.value=a.reflectivity,e.refractionRatio.value=a.refractionRatio),a.lightMap&&(e.lightMap.value=a.lightMap,e.lightMapIntensity.value=a.lightMapIntensity),a.aoMap&&(e.aoMap.value=a.aoMap,e.aoMapIntensity.value=a.aoMapIntensity);var t;if(a.map?t=a.map:a.specularMap?t=a.specularMap:a.displacementMap?t=a.displacementMap:a.normalMap?t=a.normalMap:a.bumpMap?t=a.bumpMap:a.roughnessMap?t=a.roughnessMap:a.metalnessMap?t=a.metalnessMap:a.alphaMap?t=a.alphaMap:a.emissiveMap&&(t=a.emissiveMap),void 0!==t){if(t.isWebGLRenderTarget&&(t=t.texture),!0===t.matrixAutoUpdate){var i=t.offset,n=t.repeat,r=t.rotation,o=t.center;t.matrix.setUvTransform(i.x,i.y,n.x,n.y,r,o.x,o.y)}e.uvTransform&&e.uvTransform.value.copy(t.matrix)}}function n(e,a){e.diffuse.value=a.color,e.opacity.value=a.opacity}function r(e,a){e.dashSize.value=a.dashSize,e.totalSize.value=a.dashSize+a.gapSize,e.scale.value=a.scale}function o(e,a){if(e.diffuse.value=a.color,e.opacity.value=a.opacity,e.size.value=a.size*_pixelRatio,e.scale.value=.5*_height,e.map.value=a.map,null!==a.map){if(!0===a.map.matrixAutoUpdate){var t=a.map.offset,i=a.map.repeat,n=a.map.rotation,r=a.map.center;a.map.matrix.setUvTransform(t.x,t.y,i.x,i.y,n,r.x,r.y)}e.uvTransform&&e.uvTransform.value.copy(a.map.matrix)}}function s(e,a){e.fogColor.value=a.color,a.isFog?(e.fogNear.value=a.near,e.fogFar.value=a.far):a.isFogExp2&&(e.fogDensity.value=a.density)}function l(e,a){a.emissiveMap&&(e.emissiveMap.value=a.emissiveMap)}function u(e,a){e.specular.value=a.specular,e.shininess.value=Math.max(a.shininess,1e-4),a.emissiveMap&&(e.emissiveMap.value=a.emissiveMap),a.bumpMap&&(e.bumpMap.value=a.bumpMap,e.bumpScale.value=a.bumpScale),a.normalMap&&(e.normalMap.value=a.normalMap,e.normalScale.value.copy(a.normalScale)),a.displacementMap&&(e.displacementMap.value=a.displacementMap,e.displacementScale.value=a.displacementScale,e.displacementBias.value=a.displacementBias)}function p(e,a){u(e,a),a.gradientMap&&(e.gradientMap.value=a.gradientMap)}function c(e,a){e.roughness.value=a.roughness,e.metalness.value=a.metalness,a.roughnessMap&&(e.roughnessMap.value=a.roughnessMap),a.metalnessMap&&(e.metalnessMap.value=a.metalnessMap),a.emissiveMap&&(e.emissiveMap.value=a.emissiveMap),a.bumpMap&&(e.bumpMap.value=a.bumpMap,e.bumpScale.value=a.bumpScale),a.normalMap&&(e.normalMap.value=a.normalMap,e.normalScale.value.copy(a.normalScale)),a.displacementMap&&(e.displacementMap.value=a.displacementMap,e.displacementScale.value=a.displacementScale,e.displacementBias.value=a.displacementBias),a.envMap&&(e.envMapIntensity.value=a.envMapIntensity)}function m(e,a){e.clearCoat.value=a.clearCoat,e.clearCoatRoughness.value=a.clearCoatRoughness,c(e,a)}function d(e,a){a.displacementMap&&(e.displacementMap.value=a.displacementMap,e.displacementScale.value=a.displacementScale,e.displacementBias.value=a.displacementBias)}function f(e,a){a.displacementMap&&(e.displacementMap.value=a.displacementMap,e.displacementScale.value=a.displacementScale,e.displacementBias.value=a.displacementBias),e.referencePosition.value.copy(a.referencePosition),e.nearDistance.value=a.nearDistance,e.farDistance.value=a.farDistance}function v(e,a){a.bumpMap&&(e.bumpMap.value=a.bumpMap,e.bumpScale.value=a.bumpScale),a.normalMap&&(e.normalMap.value=a.normalMap,e.normalScale.value.copy(a.normalScale)),a.displacementMap&&(e.displacementMap.value=a.displacementMap,e.displacementScale.value=a.displacementScale,e.displacementBias.value=a.displacementBias)}function M(e,a){a.fog&&s(e,a.fog),a.isMeshBasicMaterial?i(e,a):a.isMeshLambertMaterial?(i(e,a),l(e,a)):a.isMeshPhongMaterial?(i(e,a),a.isMeshToonMaterial?p(e,a):u(e,a)):a.isMeshStandardMaterial?(i(e,a),a.isMeshPhysicalMaterial?m(e,a):c(e,a)):a.isMeshDepthMaterial?(i(e,a),d(e,a)):a.isMeshDistanceMaterial?(i(e,a),f(e,a)):a.isMeshNormalMaterial?(i(e,a),v(e,a)):a.isLineBasicMaterial?(n(e,a),a.isLineDashedMaterial&&r(e,a)):a.isPointsMaterial?o(e,a):a.isShadowMaterial&&(e.color.value=a.color,e.opacity.value=a.opacity),void 0!==e.ltcMat&&(e.ltcMat.value=THREE.UniformsLib.LTC_MAT_TEXTURE),void 0!==e.ltcMag&&(e.ltcMag.value=THREE.UniformsLib.LTC_MAG_TEXTURE)}Object.defineProperty(a,"__esModule",{value:!0}),a.updateUniforms=M}])});