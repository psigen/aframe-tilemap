!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("three"),require("aframe")):"function"==typeof define&&define.amd?define("aframeTilemap",["three","aframe"],t):"object"==typeof exports?exports.aframeTilemap=t(require("three"),require("aframe")):e.aframeTilemap=t(e.THREE,e.AFRAME)}("undefined"!=typeof self?self:this,function(e,t){return function(e){function t(i){if(a[i])return a[i].exports;var n=a[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var a={};return t.m=e,t.c=a,t.d=function(e,a,i){t.o(e,a)||Object.defineProperty(e,a,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var a=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(a,"a",a),a},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=4)}([function(t,a){t.exports=e},function(e,a){e.exports=t},function(e,t,a){"use strict";function i(e){var t=e.data.readyEvent;return t?new Promise(function(a,i){e.el.addEventListener(t,function(e){setTimeout(function(){a()},100)})}):Promise.resolve()}Object.defineProperty(t,"__esModule",{value:!0}),t.waitUntilLoaded=i},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=t.SHADERLIB_MATERIALS={MeshBasicMaterial:THREE.ShaderLib.basic,MeshStandardMaterial:THREE.ShaderLib.standard};t.M_TAU_SCALED=2*Math.PI/256,t.Z_AXIS=new THREE.Vector3(0,0,1),t.SHADERLIB_DEFAULT_MATERIAL=i.MeshStandardMaterial},function(e,t,a){"use strict";a(5),a(6),a(8),AFRAME.registerComponent("tile",{schema:{id:{type:"int"},readyEvent:{type:"string",default:""}}})},function(e,t,a){"use strict";var i=function(){function e(e,t){var a=[],i=!0,n=!1,r=void 0;try{for(var o,l=e[Symbol.iterator]();!(i=(o=l.next()).done)&&(a.push(o.value),!t||a.length!==t);i=!0);}catch(e){n=!0,r=e}finally{try{!i&&l.return&&l.return()}finally{if(n)throw r}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),n=a(0),r=(function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);t.default=e}(n),a(1)),o=function(e){return e&&e.__esModule?e:{default:e}}(r),l=a(2),s=a(3);o.default.registerComponent("tilemap-cloned",{schema:{src:{type:"asset"},tileWidth:{type:"number",default:1},tileHeight:{type:"number",default:1},origin:{type:"vec2",default:{x:.5,y:.5}},debug:{type:"boolean",default:!0}},init:function(){var e=this,t=this.el,a=this.tiles={},i=[],n=!0,r=!1,o=void 0;try{for(var s,u=t.children[Symbol.iterator]();!(n=(s=u.next()).done);n=!0){var c=s.value,p=c.components.tile;p&&(a[p.data.id]=p,i.push((0,l.waitUntilLoaded)(p)))}}catch(e){r=!0,o=e}finally{try{!n&&u.return&&u.return()}finally{if(r)throw o}}Promise.all(i).then(function(){e.constructClones(),e.el.emit("model-loaded")})},constructClones:function(){var e=performance.now(),t=this.tiles,a=this.data.src,n=a.naturalWidth,r=a.naturalHeight,o=this.data.tileWidth,l=-this.data.tileHeight,u=-o*n*this.data.origin.x,c=-l*r*this.data.origin.y,p=document.createElement("canvas"),m=p.getContext("2d");m.drawImage(a,0,0);for(var f=m.getImageData(0,0,n,r).data,d=0,v=0;v<r;++v)for(var h=0;h<n;++h){var M=f.slice(d,d+4),y=i(M,4),g=y[0],b=y[1],S=y[2];y[3];d+=4;var x=256*g+b,E=s.M_TAU_SCALED*S;if(x in t){var A=t[x],w=A.el.object3D,_=w.clone();_.translateX(o*h+u),_.translateY(l*v+c),_.rotateZ(E),_.visible=!0,this.el.object3D.add(_)}}if(this.data.debug){var T=performance.now();console.log("Tile cloning took "+(T-e)+" milliseconds.")}}})},function(e,t,a){"use strict";var i=function(){function e(e,t){var a=[],i=!0,n=!1,r=void 0;try{for(var o,l=e[Symbol.iterator]();!(i=(o=l.next()).done)&&(a.push(o.value),!t||a.length!==t);i=!0);}catch(e){n=!0,r=e}finally{try{!i&&l.return&&l.return()}finally{if(n)throw r}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),n=a(0),r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t.default=e,t}(n),o=a(1),l=function(e){return e&&e.__esModule?e:{default:e}}(o),s=a(7),u=a(2),c=a(3);l.default.registerComponent("tilemap-instanced",{schema:{src:{type:"asset"},tileWidth:{type:"number",default:1},tileHeight:{type:"number",default:1},origin:{type:"vec2",default:{x:.5,y:.5}},debug:{type:"boolean",default:!0}},init:function(){var e=this,t=this.el,a=this.tiles={},i=!0,n=!1,r=void 0;try{for(var o,l=t.children[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var s=o.value,u=s.components.tile;u&&(a[u.data.id]={entity:u,meshes:{},instances:{offsets:[]}})}}catch(e){n=!0,r=e}finally{try{!i&&l.return&&l.return()}finally{if(n)throw r}}this.constructTiles().then(function(){e.constructInstances(),e.constructMeshes()}).then(function(){e.el.emit("model-loaded")})},constructMeshes:function(){var e=performance.now(),t=this.tiles;for(var a in t){var i=t[a],n=i.instances;if(!(n.offsets.length<=0)){var o=new r.InstancedBufferAttribute(new Float32Array(n.offsets),3);for(var l in i.meshes){var u=i.meshes[l],p=u.geometry,m=u.mesh.material,f=c.SHADERLIB_MATERIALS[m.type]||c.SHADERLIB_DEFAULT_MATERIAL,d=r.UniformsUtils.clone(f.uniforms);(0,s.updateUniforms)(d,m);var v=new r.ShaderMaterial({uniforms:d,vertexShader:"\nprecision highp float;\n\nattribute vec3 tilemapOffset;\n\nvarying vec2 vUv;\nvarying vec3 vNormal;\nvarying vec3 vViewPosition;\n\nvoid main() {\n  vec4 tilemapOrientation = vec4(0, 0, cos(tilemapOffset.z), sin(tilemapOffset.z));\n  vec3 tilemapPosition = vec3(tilemapOffset.xy, 0.0);\n\n  vec3 vPosition = position;\n  vec3 vcV = cross( tilemapOrientation.xyz, vPosition );\n  vPosition = vcV * ( 2.0 * tilemapOrientation.w ) + ( cross( tilemapOrientation.xyz, vcV ) * 2.0 + vPosition );\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( tilemapPosition + vPosition, 1.0 );\n}\n",fragmentShader:f.fragmentShader,lights:m.lights,defines:{USE_MAP:!!m.map,USE_ENVMAP:!!m.envMap,USE_AOMAP:!!m.aoMap,USE_EMISSIVEMAP:!!m.emissiveMap,USE_BUMPMAP:!!m.bumpMap,USE_NORMALMAP:!!m.normalMap,USE_SPECULARMAP:!!m.specularMap,USE_ROUGHNESSMAP:!!m.roughnessMap,USE_METALNESSMAP:!!m.metalnessMap,USE_ALPHAMAP:!!m.alphaMap,USE_COLOR:!!m.vertexColors,FLAT_SHADED:!!m.flatShading,DOUBLE_SIDED:!!m.doubleSided,FLIP_SIDED:!m.flipSided}}),h=new r.InstancedBufferGeometry;h.index=p.index;for(var M in p.attributes)h.addAttribute(M,p.getAttribute(M));h.addAttribute("tilemapOffset",o);var y=new r.Mesh(h,v);this.el.object3D.add(y)}}}if(this.data.debug){var g=performance.now();console.log("Tile mesh creation took "+(g-e).toFixed(2)+" ms.")}},constructInstances:function(){var e=performance.now(),t=this.tiles,a=this.data.src,n=a.naturalWidth,r=a.naturalHeight,o=this.data.tileWidth,l=-this.data.tileHeight,s=-o*n*this.data.origin.x,u=-l*r*this.data.origin.y,p=document.createElement("canvas"),m=p.getContext("2d");m.drawImage(a,0,0);for(var f=m.getImageData(0,0,n,r).data,d=0,v=0;v<r;++v)for(var h=0;h<n;++h){var M=f.slice(d,d+4),y=i(M,4),g=y[0],b=y[1],S=y[2];y[3];d+=4;var x=256*g+b;if(x in t){var E=t[x].instances,A=o*h+s,w=l*v+u,_=c.M_TAU_SCALED*S;E.offsets.push(A,w,_)}}if(this.data.debug){var T=performance.now();console.log("Tile instancing took "+(T-e).toFixed(2)+" ms.")}},constructTiles:function(){var e=performance.now(),t=this.tiles,a=[];this.el.object3D.updateMatrixWorld();var i=(new r.Matrix4).getInverse(this.el.object3D.matrixWorld);for(var n in t)!function(e){var n=t[e],o=n.meshes,l=(0,u.waitUntilLoaded)(n.entity).then(function(){n.entity.el.object3D.traverse(function(e){if("Mesh"===e.type){var t="BufferGeometry"===e.geometry.type?(new r.BufferGeometry).copy(e.geometry):(new r.BufferGeometry).fromGeometry(e.geometry);e.updateMatrixWorld();var a=(new r.Matrix4).copy(i).multiply(e.matrixWorld);t.applyMatrix(a),o[e.uuid]={mesh:e,geometry:t}}})});a.push(l)}(n);if(this.data.debug){var o=performance.now();console.log("Tile definition took "+(o-e).toFixed(2)+" ms.")}return Promise.all(a)},update:function(e){},remove:function(){}})},function(e,t,a){"use strict";function i(e,t){e.opacity.value=t.opacity,t.color&&(e.diffuse.value=t.color),t.emissive&&e.emissive.value.copy(t.emissive).multiplyScalar(t.emissiveIntensity),t.map&&(e.map.value=t.map),t.alphaMap&&(e.alphaMap.value=t.alphaMap),t.specularMap&&(e.specularMap.value=t.specularMap),t.envMap&&(e.envMap.value=t.envMap,e.flipEnvMap.value=t.envMap&&t.envMap.isCubeTexture?-1:1,e.reflectivity.value=t.reflectivity,e.refractionRatio.value=t.refractionRatio),t.lightMap&&(e.lightMap.value=t.lightMap,e.lightMapIntensity.value=t.lightMapIntensity),t.aoMap&&(e.aoMap.value=t.aoMap,e.aoMapIntensity.value=t.aoMapIntensity);var a;if(t.map?a=t.map:t.specularMap?a=t.specularMap:t.displacementMap?a=t.displacementMap:t.normalMap?a=t.normalMap:t.bumpMap?a=t.bumpMap:t.roughnessMap?a=t.roughnessMap:t.metalnessMap?a=t.metalnessMap:t.alphaMap?a=t.alphaMap:t.emissiveMap&&(a=t.emissiveMap),void 0!==a){if(a.isWebGLRenderTarget&&(a=a.texture),!0===a.matrixAutoUpdate){var i=a.offset,n=a.repeat,r=a.rotation,o=a.center;a.matrix.setUvTransform(i.x,i.y,n.x,n.y,r,o.x,o.y)}e.uvTransform&&e.uvTransform.value.copy(a.matrix)}}function n(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}function r(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}function o(e,t){if(e.diffuse.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size*_pixelRatio,e.scale.value=.5*_height,e.map.value=t.map,null!==t.map){if(!0===t.map.matrixAutoUpdate){var a=t.map.offset,i=t.map.repeat,n=t.map.rotation,r=t.map.center;t.map.matrix.setUvTransform(a.x,a.y,i.x,i.y,n,r.x,r.y)}e.uvTransform&&e.uvTransform.value.copy(t.map.matrix)}}function l(e,t){e.fogColor.value=t.color,t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)}function s(e,t){t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}function u(e,t){e.specular.value=t.specular,e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function c(e,t){u(e,t),t.gradientMap&&(e.gradientMap.value=t.gradientMap)}function p(e,t){e.roughness.value=t.roughness,e.metalness.value=t.metalness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap),t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias),t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}function m(e,t){e.clearCoat.value=t.clearCoat,e.clearCoatRoughness.value=t.clearCoatRoughness,p(e,t)}function f(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function d(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias),e.referencePosition.value.copy(t.referencePosition),e.nearDistance.value=t.nearDistance,e.farDistance.value=t.farDistance}function v(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function h(e,t){t.fog&&l(e,t.fog),t.isMeshBasicMaterial?i(e,t):t.isMeshLambertMaterial?(i(e,t),s(e,t)):t.isMeshPhongMaterial?(i(e,t),t.isMeshToonMaterial?c(e,t):u(e,t)):t.isMeshStandardMaterial?(i(e,t),t.isMeshPhysicalMaterial?m(e,t):p(e,t)):t.isMeshDepthMaterial?(i(e,t),f(e,t)):t.isMeshDistanceMaterial?(i(e,t),d(e,t)):t.isMeshNormalMaterial?(i(e,t),v(e,t)):t.isLineBasicMaterial?(n(e,t),t.isLineDashedMaterial&&r(e,t)):t.isPointsMaterial?o(e,t):t.isShadowMaterial&&(e.color.value=t.color,e.opacity.value=t.opacity),void 0!==e.ltcMat&&(e.ltcMat.value=THREE.UniformsLib.LTC_MAT_TEXTURE),void 0!==e.ltcMag&&(e.ltcMag.value=THREE.UniformsLib.LTC_MAG_TEXTURE)}Object.defineProperty(t,"__esModule",{value:!0}),t.updateUniforms=h},function(e,t,a){"use strict";var i=function(){function e(e,t){var a=[],i=!0,n=!1,r=void 0;try{for(var o,l=e[Symbol.iterator]();!(i=(o=l.next()).done)&&(a.push(o.value),!t||a.length!==t);i=!0);}catch(e){n=!0,r=e}finally{try{!i&&l.return&&l.return()}finally{if(n)throw r}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),n=a(0),r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t.default=e,t}(n),o=a(1),l=function(e){return e&&e.__esModule?e:{default:e}}(o),s=a(2),u=a(3);l.default.registerComponent("tilemap-merged",{schema:{src:{type:"asset"},tileWidth:{type:"number",default:1},tileHeight:{type:"number",default:1},origin:{type:"vec2",default:{x:.5,y:.5}},debug:{type:"boolean",default:!0}},init:function(){var e=this,t=this.el,a=this.tiles={},i=!0,n=!1,r=void 0;try{for(var o,l=t.children[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var s=o.value,u=s.components.tile;u&&(a[u.data.id]={entity:u,meshes:{},geometries:{}})}}catch(e){n=!0,r=e}finally{try{!i&&l.return&&l.return()}finally{if(n)throw r}}this.constructTiles().then(function(){e.constructGeometry(),e.constructMeshes()}).then(function(){e.el.emit("model-loaded")})},constructMeshes:function(){var e=performance.now(),t=this.tiles;for(var a in t){var i=t[a],n=i.meshes;for(var o in n){var l=n[o],s=l.mesh,u=l.mergedGeometry,c=new r.Mesh(u,s.material);this.el.object3D.add(c)}}if(this.data.debug){var p=performance.now();console.log("Tile mesh creation took "+(p-e).toFixed(2)+" ms.")}},constructGeometry:function(){var e=performance.now(),t=this.tiles,a=this.data.src,n=a.naturalWidth,o=a.naturalHeight,l=this.data.tileWidth,s=-this.data.tileHeight,c=-l*n*this.data.origin.x,p=-s*o*this.data.origin.y,m=document.createElement("canvas"),f=m.getContext("2d");f.drawImage(a,0,0);var d=f.getImageData(0,0,n,o).data;this.el.object3D.parent.updateMatrixWorld();for(var v=(new r.Matrix4).getInverse(this.el.object3D.matrixWorld),h=0,M=0;M<o;++M)for(var y=0;y<n;++y){var g=d.slice(h,h+4),b=i(g,4),S=b[0],x=b[1],E=b[2];b[3];h+=4;var A=256*S+x,w=u.M_TAU_SCALED*E;if(A in t){var _=l*y+c,T=s*M+p;this.addTileGeometry(A,_,T,w,v)}}if(this.data.debug){var P=performance.now();console.log("Tile geometry merging took "+(P-e).toFixed(2)+" ms.")}},addTileGeometry:function(e,t,a,i,n){var o=this.tiles[e].meshes;for(var l in o){var s=o[l],u=s.mesh,c=s.mergedGeometry,p=(new r.Matrix4).makeTranslation(t,a,0);p.multiply((new r.Matrix4).makeRotationZ(i)),p.multiply(n),p.multiply(u.matrixWorld);var m=u.geometry;m instanceof r.BufferGeometry&&(m=(new r.Geometry).fromBufferGeometry(u.geometry)),c.merge(m,p)}},constructTiles:function(){var e=performance.now(),t=this.tiles,a=[];for(var i in t)!function(e){var i=t[e],n=i.entity,o=i.meshes,l=(0,s.waitUntilLoaded)(n).then(function(){n.el.object3D.traverse(function(e){if("Mesh"===e.type){e.updateMatrixWorld();var t=new r.Geometry;o[e.uuid]={mesh:e,mergedGeometry:t}}})});a.push(l)}(i);if(this.data.debug){var n=performance.now();console.log("Tile cache creation took "+(n-e).toFixed(2)+" ms.")}return Promise.all(a)},update:function(e){},remove:function(){}})}])});